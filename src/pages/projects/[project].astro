---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

export async function getStaticPaths() {
    const esDescriptions = import.meta.glob('../../project-descriptions/*/descripcion.md');
    
    return Object.keys(esDescriptions).map(path => {
        const parts = path.split('/');
        const folder = parts[parts.length - 2];
        return {
            params: { project: folder }
        };
    });
}

const { project } = Astro.params;

// Load descriptions from the new location
const esDescriptions = import.meta.glob('../../project-descriptions/*/descripcion.md');
const enDescriptions = import.meta.glob('../../project-descriptions/*/descripcion.en.md');

const EsContent = (await esDescriptions[`../../project-descriptions/${project}/descripcion.md`]()).default;
const EnContent = (await enDescriptions[`../../project-descriptions/${project}/descripcion.en.md`]()).default;

// Load images
const allImages = import.meta.glob('../../assets/*/*.{png,jpg,jpeg,webp}', { eager: true });
const projectImages = Object.keys(allImages)
    .filter(path => path.includes(`/${project}/`))
    .map(path => (allImages[path] as any).default.src);

const translations = {
    backToProjects: { en: '← Back to Evidences', es: '← Volver a Evidencias' },
    gallery: { en: 'Gallery', es: 'Galería' },
    stack: { en: 'Technologies', es: 'Tecnologías' },
    links: { en: 'Links', es: 'Enlaces' }
};

function parseProjectData(content: string) {
    const lines = content.split('\n');
    const title = lines[0].replace(/# /g, '').trim();
    const summary = lines[1].trim();
    
    const stackIndex = lines.findIndex(l => l.includes('## Stack'));
    const linksIndex = lines.findIndex(l => l.includes('## Links'));
    
    const stack = stackIndex !== -1 ? lines[stackIndex + 1].split(',').map(s => s.trim()) : [];
    const linksRaw = linksIndex !== -1 ? lines.slice(linksIndex + 1).filter(l => l.trim()) : [];
    
    const links = linksRaw.map(l => {
        const match = l.match(/\[(.*)\]\((.*)\)/);
        if (match) return { label: match[1], url: match[2] };
        return { label: l.trim(), url: null };
    });

    return { title, summary, stack, links };
}

const esData = parseProjectData(esContent);
const enData = parseProjectData(enContent);
---

<Layout title={`${project} | Paula Marín`}>
	<Header />
	
	<main class="min-h-screen px-4 sm:px-6 md:px-6">
		<article class="max-w-3xl mx-auto pt-24 sm:pt-32 md:pt-48 pb-16 sm:pb-24 fade-in">
			
			<a href="/projects"
			   class="text-sm font-medium text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white transition-colors mb-8 inline-block"
			   data-en={translations.backToProjects.en}
			   data-es={translations.backToProjects.es}>
				{translations.backToProjects.en}
			</a>

			<!-- CONTENIDO COMPLETO DEL MARKDOWN -->
			<section class="prose dark:prose-invert max-w-none">
				{EsContent && (
					<div class="locale-es">
						<EsContent />
					</div>
				)}

				{EnContent && (
					<div class="locale-en">
						<EnContent />
					</div>
				)}
			</section>

			<!-- Galería opcional -->
			{projectImages.length > 0 && (
				<section class="mt-12">
					<h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-6"
					    data-en={translations.gallery.en}
					    data-es={translations.gallery.es}>
						{translations.gallery.en}
					</h2>
					<div class="grid grid-cols-1 gap-8">
						{projectImages.map((src) => (
							<div class="relative rounded-2xl overflow-hidden border border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900/50">
								<img src={src} alt="Project screenshot" class="w-full h-auto" loading="lazy" />
							</div>
						))}
					</div>
				</section>
			)}

		</article>
	</main>

	<Footer />

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			document.querySelector('.fade-in')?.classList.add('visible');
		});
	</script>
</Layout>

<style>
	@reference "../../styles/global.css";
</style>